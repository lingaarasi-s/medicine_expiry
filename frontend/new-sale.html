<!DOCTYPE html>
<html>
<head>
    <title>New Sale</title>
    <style>
        #medicineBox { margin-bottom: 10px; }
    </style>
</head>
<body>

<h2>üßæ New Sale Bill</h2>

<!-- üîç Search -->
<input type="text" id="search" placeholder="Medicine name"
       oninput="medicineSelected=false; filterMedicines()">
<br><br>

<!-- üîΩ Medicine Dropdown -->
<div id="medicineBox" style="display:none;">
    <select id="medicine" size="5" style="width:300px"
            onchange="setSearchFromSelection()"></select>
</div>

<!-- üì¶ Quantity & Price -->
<input type="number" id="qty" placeholder="Quantity"><br><br>
<input type="number" id="price" placeholder="Price per unit"><br><br>

<!-- üõí CART BUTTONS -->
<button onclick="addToCart()">‚ûï Add Item</button>
<button onclick="submitBill()">üßæ Generate Bill</button>

<p id="msg"></p>

<hr>

<h3>üõí Current Bill Items</h3>
<ul id="cartList"></ul>

<button onclick="goDashboard()">üè† Dashboard</button>

<script>

    function goDashboard() {
    window.location.href = "index.html";
}
/* ==========================
   LOAD MEDICINES
========================== */
let medicines = [];
let medicineSelected = false;
let cart = [];

fetch("http://localhost:8080/api/medicine/all")
.then(res => res.json())
.then(data => {
    medicines = data;
});

/* ==========================
   DROPDOWN LOGIC
========================== */
function renderOptions(data) {
    const sel = document.getElementById("medicine");
    sel.innerHTML = "";

    data.forEach(m => {
        sel.innerHTML += `
            <option value="${m.id}">
                ${m.name} | Stock: ${m.quantity}
            </option>
        `;
    });
}

function filterMedicines() {
    const value = document.getElementById("search").value.toLowerCase();

    if (!value) {
        document.getElementById("medicineBox").style.display = "none";
        return;
    }

    const filtered = medicines.filter(m =>
        m.name.toLowerCase().includes(value) &&
        new Date(m.expiryDate) >= new Date()
    );


    if (filtered.length === 0) {
        document.getElementById("medicineBox").style.display = "none";
        return;
    }

    renderOptions(filtered);
    document.getElementById("medicineBox").style.display = "block";
}

function setSearchFromSelection() {
    const sel = document.getElementById("medicine");
    const text = sel.options[sel.selectedIndex].text;
    const name = text.split("|")[0].trim();

    document.getElementById("search").value = name;
    document.getElementById("medicineBox").style.display = "none";
}

/* ==========================
   üõí CART LOGIC (YOUR CODE)
========================== */
function addToCart() {
    const id = document.getElementById("medicine").value;
    const name = document.getElementById("search").value;
    const qty = parseInt(document.getElementById("qty").value);
    const price = parseFloat(document.getElementById("price").value);

    if (!id || qty <= 0 || price <= 0) {
        alert("Select medicine, quantity & price");
        return;
    }

    cart.push({
        medicineId: id,
        quantity: qty,
        price: price
    });

    // show in UI
    const li = document.createElement("li");
    li.innerText = `${name} | Qty: ${qty} | ‚Çπ${price}`;
    document.getElementById("cartList").appendChild(li);

    document.getElementById("msg").innerHTML =
        `üõí ${name} added to bill`;

    // reset fields
    document.getElementById("medicine").value = "";
    document.getElementById("search").value = "";
    document.getElementById("qty").value = "";
    document.getElementById("price").value = "";
}

/* ==========================
   üßæ SUBMIT BILL
========================== */
function submitBill() {
    if (cart.length === 0) {
        alert("Cart is empty");
        return;
    }

    fetch("http://localhost:8080/api/billing/sell", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(cart)
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(t => { throw new Error(t); });
        }
        return res.json();
    })
    .then(bill => {
        alert("‚úÖ Bill Generated: " + bill.billNo);
        window.location.href = "sales.html";
    })
    .catch(err => {
        alert("‚ùå " + err.message);
    });
}

</script>

</body>
</html>
