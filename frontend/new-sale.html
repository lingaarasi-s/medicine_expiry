<!DOCTYPE html>
<html>
<head>
    <title>New Sale</title>
    <style>
        #medicineBox { margin-bottom: 10px; }
    </style>
</head>
<body>

<h2>ğŸ§¾ New Sale Bill</h2>

<!-- Customer Details -->
<input type="text" id="customerName" placeholder="Customer Name"><br><br>
<input type="text" id="customerPhone" placeholder="Customer Phone"><br><br>

<!-- ğŸ” Search -->
<input type="text" id="search" placeholder="Medicine name"
       oninput="medicineSelected=false; filterMedicines()">
<br><br>

<!-- ğŸ”½ Medicine Dropdown -->
<div id="medicineBox" style="display:none;">
    <select id="medicine" size="5" style="width:300px"
            onchange="setSearchFromSelection()"></select>
</div>

<!-- ğŸ“¦ Quantity & Price -->
<input type="number" id="qty" placeholder="Quantity"><br><br>
<div id="priceDisplay"></div><br>

<!-- ğŸ›’ CART BUTTONS -->
<button onclick="addToCart()">â• Add Item</button>
<button onclick="submitBill()">ğŸ§¾ Generate Bill</button>

<p id="msg"></p>

<hr>

<h3>ğŸ›’ Current Bill Items</h3>
<ul id="cartList"></ul>

<button onclick="goDashboard()">ğŸ  Dashboard</button>

<script>

    function goDashboard() {
    window.location.href = "index.html";
}
/* ==========================
   LOAD MEDICINES
========================== */
let medicines = [];
let medicineSelected = false;
let cart = [];
let selectedMedicine = null;

fetch("http://localhost:8080/api/medicine/all")
.then(res => res.json())
.then(data => {
    medicines = data;
});

/* ==========================
   DROPDOWN LOGIC
========================== */
function renderOptions(data) {
    const sel = document.getElementById("medicine");
    sel.innerHTML = "";

    data.forEach(m => {
        sel.innerHTML += `
            <option value="${m.id}">
                ${m.name} | Stock: ${m.quantity}
            </option>
        `;
    });
}

function filterMedicines() {
    const value = document.getElementById("search").value.toLowerCase();

    if (!value) {
        document.getElementById("medicineBox").style.display = "none";
        return;
    }

    const filtered = medicines.filter(m =>
        m.name.toLowerCase().includes(value) &&
        new Date(m.expiryDate) >= new Date()
    );


    if (filtered.length === 0) {
        document.getElementById("medicineBox").style.display = "none";
        return;
    }

    renderOptions(filtered);
    document.getElementById("medicineBox").style.display = "block";
}

function setSearchFromSelection() {
    const sel = document.getElementById("medicine");
    const id = sel.value;
    selectedMedicine = medicines.find(m => m.id == id);
    const text = sel.options[sel.selectedIndex].text;
    const name = text.split("|")[0].trim();

    document.getElementById("search").value = name;
    document.getElementById("priceDisplay").innerText = `Price: â‚¹${selectedMedicine.sellingPrice}`;
    document.getElementById("medicineBox").style.display = "none";
}

/* ==========================
   ğŸ›’ CART LOGIC (YOUR CODE)
========================== */
function addToCart() {
    const id = document.getElementById("medicine").value;
    const name = document.getElementById("search").value;
    const qty = parseInt(document.getElementById("qty").value);

    if (!selectedMedicine || qty <= 0) {
        alert("Select medicine and enter quantity");
        return;
    }

    const price = selectedMedicine.sellingPrice;

    cart.push({
        medicineId: parseInt(id),
        quantity: qty,
        price: price
    });

    // show in UI
    const li = document.createElement("li");
    li.innerText = `${name} | Qty: ${qty} | â‚¹${price}`;
    document.getElementById("cartList").appendChild(li);

    document.getElementById("msg").innerHTML =
        `ğŸ›’ ${name} added to bill`;

    // reset fields
    document.getElementById("medicine").value = "";
    document.getElementById("search").value = "";
    document.getElementById("qty").value = "";
    selectedMedicine = null;
    document.getElementById("priceDisplay").innerText = "Price: Select a medicine";
}

/* ==========================
   ğŸ§¾ SUBMIT BILL
========================== */
function submitBill() {
    if (cart.length === 0) {
        alert("Cart is empty");
        return;
    }

    const customerName = document.getElementById("customerName").value;
    const customerPhone = document.getElementById("customerPhone").value;

    if (!customerName || !customerPhone) {
        alert("Enter customer details");
        return;
    }

    const request = {
        customerName: customerName,
        customerPhone: customerPhone,
        items: cart
    };

    fetch("http://localhost:8080/api/billing/sell", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(request)
    })
    .then(res => {
        if (!res.ok) {
            return res.text().then(t => { throw new Error(t); });
        }
        return res.json();
    })
    .then(bill => {
        alert("âœ… Bill Generated: " + bill.billNo);
        window.location.href = "sales.html";
    })
    .catch(err => {
        alert("âŒ " + err.message);
    });
}

</script>

</body>
</html>
