<!DOCTYPE html>
<html>
<head>
    <title>Sales History</title>
</head>
<body>

<h2>üìä Sales History</h2>

<!-- ACTION BUTTONS -->
<button onclick="goDashboard()">üè† Dashboard</button>
<button onclick="newSale()">‚ûï New Sale</button>

<br><br>


<table border="1">
<tr>
    <th>Bill No</th>
    <th>Customer ID</th>
    <th>Medicine</th>
    <th>Batch</th>
    <th>Qty</th>
    <th>Total</th>
    <th>Date</th>
</tr>
<tbody id="list"></tbody>
</table>

<script>
function goDashboard() {
    window.location.href = "index.html";
}

function newSale() {
    window.location.href = "new-sale.html";
}

const token = localStorage.getItem("jwtToken");

if (!token) {
    alert("Please login again");
    window.location.href = "login.html";
}

fetch("http://localhost:8080/api/billing/history", {
    headers: {
        "Authorization": "Bearer " + token
    }
})
.then(res => {
    if (!res.ok) throw new Error("Unauthorized");
    return res.json();
})
.then(data => {

    const tbody = document.getElementById("list");
    tbody.innerHTML = "";

    // ‚úÖ GROUP BY BILL NO
    const grouped = {};
    data.forEach(item => {
        const billNo = item.bill.billNo;
        if (!grouped[billNo]) {
            grouped[billNo] = [];
        }
        grouped[billNo].push(item);
    });

    // ‚úÖ RENDER WITH ROWSPAN
    Object.keys(grouped).forEach(billNo => {
        const items = grouped[billNo];
        const rowSpan = items.length;

        items.forEach((s, index) => {
            let row = "<tr>";

            if (index === 0) {
                row += `<td rowspan="${rowSpan}">${s.bill.billNo}</td>`;
                row += `<td rowspan="${rowSpan}">${s.bill.customerId}</td>`;
            }

            row += `
                <td>${s.medicineName}</td>
                <td>${s.batchNo}</td>
                <td>${s.quantity}</td>
                <td>‚Çπ${s.totalAmount}</td>
            `;

            if (index === 0) {
                row += `<td rowspan="${rowSpan}">${s.bill.saleDate}</td>`;
            }

            row += "</tr>";
            tbody.innerHTML += row;
        });
    });
})
.catch(err => {
    alert("‚ùå " + err.message);
});
</script>



</body>
</html>
